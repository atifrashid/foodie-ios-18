<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Fudi</title>

<!-- Sets initial viewport load and disables zooming  -->
<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, width=device-width" />

<!-- Makes your prototype chrome-less once bookmarked to your phone's home screen -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="mobile-web-app-capable" content="yes">
<link href="css/bootstrap.min.css" rel="stylesheet">
<link href="css/font-awesome.min.css" rel="stylesheet">
<link href="css/styles.css" rel="stylesheet">
<link href="css/chat.css" rel="stylesheet">



<!--
<script src="js/angular.min.js"></script>
<script src="js/angular-route.min.js"></script>
<script src="js/mobile-angular-ui.min.js"></script>
<script src="js/mobile-angular-ui.gestures.min.js"></script>
<script src='js/chat.js'></script>-->
</head>
<body id="wrapper">
<div id="sidebar-wrapper">
	<nav id="nav">
		<ul class="sidebar-nav nav" id="navRight">
			<li class="L0 menu-heading"><strong><a href="#"><i class="icon-user"></i> <span data-bind="text: lang.Fudi"></span></a></strong></li>
			<li class="L2"><a class="sub" href="map.html"><i class="icon-pointer-advice"></i> <span data-bind="text: lang.mnuChefs"></span></a></li>
			<li class="L2"><a class="sub" href="user-profile.html"><i class="icon-user"></i> <span data-bind="text: lang.MyProfile"></span></a></li>
			<li class="L2"><a class="sub" href="payment-options.html"><i class="icon-credit-cards"></i> <span data-bind="text: lang.PO"></span></a></li>
			<li class="L2"><a class="sub" href="reservations.html"><i class="icon-tray"></i> <span data-bind="text: lang.MyOrders"></span></a></li>
			
			<li class="L2"><a class="sub" href="events-list.html"><i class="fa fa-glass"></i> <span data-bind="text: lang.Events"></span></a></li>
			<li class="L0 menu-heading"><strong><a href="#"><i class="icon-chef"></i> <span data-bind="text: lang.CHEF"></span></a></strong></li>
			<li class="L2 noChef"><a class="sub" href="chef-profile-edit.html"><i class="icon-chef"></i> <span data-bind="text: lang.BecomeaChef"></span></a></li>
			<li class="L2 isChef pChef"><a class="sub" href="chef-profile-edit.html"><i class="icon-chef"></i> <span data-bind="text: lang.ChefProfile"></span></a></li>
			<li class="L2 isChef"><a class="sub" href="chef-dishes.html"><i class="icon-food"></i> <span data-bind="text: lang.ManageDishes"></span></a></li>
			<li class="L2 isChef"><a class="sub" href="chef-calendar-set.html"><i class="icon-clock"></i> <span data-bind="text: lang.Schedule"></span></a></li>
			<li class="L2 isChef"><a class="sub" href="delivery-schedule.html"><i class="icon-calendar"></i> <span data-bind="text: lang.DeliverySchedule"></span></a></li>
			<li class="L2 isChef"><a class="sub" href="ps-schedule.html"><i class="icon-calendar-1"></i> <span data-bind="text: lang.PSmenu"></span></a></li>
			<li class="L2 isChef"><a class="sub" href="chef-reservations.html"><i class="icon-reserve"></i> <span data-bind="text: lang.ChefReservations"></span></a></li>
			<li class="L2 isChef"><a class="sub" href="chef-events.html"><i class="fa fa-glass"></i> <span data-bind="text: lang.eventResv"></span></a></li>
			<li class="L2 isChef"><a class="sub" href="withdraw-money-chef.html"><i class="icon-withdraw"></i> <span data-bind="text: lang.WithdMon"></span></a></li>
			<li class="L1"><a href="chat.html"><i class="fa fa-comments"></i> <span data-bind="text: lang.Chat"></span></a></li>
			<li class="L1"><a href="settings.html"><i class="icon-gear"></i> <span data-bind="text: lang.Settings"></span></a></li>
			<li class="L1"><a href="about.html"><i class="icon-about"></i> <span data-bind="text: lang.AboutFudi"></span></a></li>
			<li class="L1"><a href="register.html?do=logout"><i class="icon-logout"></i> <span data-bind="text: lang.Logout"></span></a></li>
		</ul>
	</nav>
</div>


<div id="notification-page" class="content">
	
	<h1 id="menu-button"> <a id="menu-toggle" href="#" class="btn-menu toggle"> <i class="fa fa-bars"></i> </a> 
	<p class="pageTitle" xdata-bind="text: lang.ChefRes">Chat</p>
	</h1>
	
	<div class="wrapper main-div" style="margin-top:90px !important">
		<div class="container">
			<div class="row">
				<div class="col-sm-12 no-padding">
					<div class="left" >
						<ul class="people" id="dataList">
							<li class="person hidden chatMainLi"> <img src="http://s3.postimg.org/yf86x7z1r/img2.jpg" alt="" /> <span class="name"></span> <span class="time">1:44 PM</span> <span class="preview">I've forgotten how it felt before<span class="badge">5</span></span> </li>
						</ul>
					</div>
				</div>
				<div class="right" style="display:none">
					<div class="top"><span class="back" id="chatWinBack"><i  class="fa fa-long-arrow-left"></i></span><span>To: <span id="chatWinName" class="name">Dog Woofson</span></div>
					<div class="chat active-chat">
						<div id="spMsgs" class="conversation-start"> <span>Monday, 1:27 PM</span> </div>
						
						
						
						
					</div>
					<div class="write">
						<form method="post" id="frmSend" style="display:inline">
							<input type="text" class="form-control" id="txtMsg" ng-model="msgTxt"  />
							<a href="#" id="aSend" class="write-link send"><i class="fa fa-paper-plane" aria-hidden="true"></i></a>
							
						</form>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
<br />
<br />
<br />
<br />
<br />
<br />
<div id="bottom-bar">
	<div class="container">
		<div class="row">
			<div class=" no-padding"> <a class="tab-item " href="map.html"> <i class="fa fa-map-marker"></i> </a> </div>
			<div class=" no-padding"> <a class="tab-item" href="reservations.html"> <i class="fa fa-cutlery"></i> </a> </div>
			<div class=" no-padding"> <a class="tab-item " href="user-profile.html"> <i class="fa fa-user"></i> </a> </div>
			<div class=" no-padding"> <a class="tab-item active" id="afchat" href="chat.html"> <i class="fa fa-comments"></i> </a>	</div>
		</div>
	</div>
</div>
<script src="cordova.js"></script> 
<script src="js/jquery-1.11.3.min.js"></script> 
<script src="js/jquery.validate.min.js"></script> 
<script src="js/bootstrap.min.js"></script>
<script src="js/moment.min.js"></script>  
<script src='js/knockout-3.4.0.js'></script> 
<script src="js/common.js"></script> 
<script>

chatData = [];
ActiveChatIndex = -1;
var parId = null;
var chatWinData = null;

var chefData = null;
var userData = null;

$(document).ready(function(e) {
	
	//document.write( '<style>#bottom-bar{visibility:hidden}@media(min-height:' + ($(document).height() - 10) + 'px){#bottom-bar{visibility:visible}}</style>' );
	//$('head').append('<style>#bottom-bar{display:none;} .write{bottom:10px} @media(min-height:' + ($(document).height() - 20) + 'px){#bottom-bar{display:block} .write{bottom:55px}}</style>');
	if(!empty(localStorage.getItem('chefData'))){
		chefData =  JSON.parse(localStorage.getItem('chefData'));	
	}
	
	if(!empty(localStorage.getItem('userData'))){
		userData =  JSON.parse(localStorage.getItem('userData'));	
	}
	
	var user_profile_complete = false;
	if( !empty(localStorage.getItem('userData'))){
		var userData = JSON.parse(localStorage.getItem('userData'));
		if( !empty(userData.first_name) && !empty(userData.last_name) && !empty(userData.phone)  ){
			user_profile_complete = true;	
		}
	}
	if( user_profile_complete == false ){
		$('div.main-div div.container').append('<div class="alert alert-danger lead">In order to use chat feature, you need to complete your profile. Please tap <a href="user-profile.html">HERE</a> to complete your profile!</div>');
	}else{
		loadMainData();	
	}

	
	
	$('#frmSend').on('submit',function(event){
		event.preventDefault();
		if(empty($('#txtMsg').val())) return false;
		
		var sender_name = '';
		if( chatData[ActiveChatIndex].person2=='user'){ // I am a chef
			sender_name = chefData.company;
		}else{
			sender_name = userData.first_name; 
		}
		
		var formData = {
			userId: localStorage.getItem('userId'),
			userToken: localStorage.getItem('userToken'),
			msg: $('#txtMsg').val(),
			to: chatData[ActiveChatIndex].id,
			toName : chatData[ActiveChatIndex].name,
			chef_is: (chatData[ActiveChatIndex].person2=='chef')?'to':'from',
			sender_name : sender_name
		};
		
		chatData[ActiveChatIndex].msgs.unshift({'msg':formData.msg, 'dir': 'out', 'date': moment().format("YYYY-MM-DD HH:mm") });
		var H = '<div class="bubble me">'+formData.msg+'</div>';
		$('#spMsgs').append(H);
		//$(document).scrollTop($(document).height());
		$("html, body").animate({ scrollTop: $(document).height() }, 500);
		
		$('#txtMsg').val('');
		
		$.ajax({
			type: "POST", dataType: 'json', url: ServerAjax+"?h=sendChatMsg", data: formData,
			//beforeSend: function() { waitingDialog.show(cLan.Loading, {dialogSize: 'sm', progressType: 'info'}); },
			//complete: function() { waitingDialog.hide(); },
			}).fail(  ajaxError
			).done(function(data){
				if (data.Success == 'true') {
					//console.log( $('.food-listing') );
					
				} else { 
					ErrorModalWithParm(data);
				}
				if (data.JS) { eval(data.JS); }
		}); // ajax	
	});
	
	
	$('#aSend').on('click', function(e){
		
		e.preventDefault();
		$('#frmSend').submit();

	});
	
	
	$('#chatWinBack').on('click',function(){ // open chat left
		loadChatLeft();
		$('div.right').hide();
		$('div.left').show();	
	});
	
	$('#dataList').on('click','li', function(){ // open chat window
		
		var opp_id = $(this).data('index');
		openChatWindow(opp_id);
		
	});
	
	$('#txtMsg').on('focus',function(){
		$("html, body").animate({ scrollTop: $(document).height() }, 500);
	});
	
});




function loadMainData(){
	
	var formData = {	userId: localStorage.getItem('userId'), userToken: localStorage.getItem('userToken') };
	
	$.ajax({
		type: "POST", dataType: 'json', url: ServerAjax+"?h=getChatMsgs", data: formData,
		beforeSend: function() { waitingDialog.show(cLan.Loading, {dialogSize: 'sm', progressType: 'info'}); },
		complete: function() { waitingDialog.hide(); },
	}).fail(  ajaxError )
	.done(function(data){
		if (data.Success == 'true') {
			chatData = data.chat;
			
			
			loadChatLeft();
			
			// ===================== NEW CHAT STARTED  ================		
			parId = getUrlParameter('c');
			if( !empty( parId ) ){
				var chef_data = null;
				var jsonData = JSON.parse(localStorage.getItem('nearbyChefs'));
				for (var i = 0; i < jsonData.length; i++) {
					if( jsonData[i].id == parId ){
						chef_data = jsonData[i];
						break;
					}
				}
				var scIndex = -1;
				if(!empty(chatData)){
					for (var i = 0; i < chatData.length; i++) {
						if( chatData[i].id == parId ){ scIndex = i; break; }
					}
				}
				
				//var jsonData = JSON.parse(localStorage.getItem('userData'));	
				//var mee = jsonData.first_name+' '+jsonData.last_name;
				
				
				chatWinData = { 'id': parId, 'name': chef_data['company'], 'msgs': [], 'image1': chef_data['image1'], 'person2': 'chef' };  //'me': mee, 'chef_is': 'to' }; 
				if(empty(chatData)){
					chatData.push(chatWinData);
					chatIndex = 0;
				}else if( scIndex == -1 ){ // new chat initiated
					chatData.unshift(chatWinData);
					chatIndex = 0;
				}else{
					chatIndex = scIndex;
				}

				openChatWindow(chatIndex);
			}
			// ===================== NEW CHAT STARTED =====================
			
			//$("#user-form").show();
		} else { 
			ErrorModalWithParm(data);
		}
		if (data.JS) { eval(data.JS); }
	
	}); // ajax	
}

function loadChatLeft(){
	
	$('#dataList li').not(':first').remove();
	$DTemp = $('.chatMainLi');
	ActiveChatIndex  = -1;
	var ChatsNew = 0; // unred conversactions 
	
	for (var i = 0; i < chatData.length; i++) {
		var Th = chatData[i];
		console.log(Th);
		$copy = $DTemp.clone().removeClass('hidden');
		$copy.find('span.name').html(Th.name);
		$copy.data('index',i);
		$copy.data('id',Th.id);
		
		if( Th.msgs.length > 0 ){
			$copy.find('span.time').html( moment( Th.msgs[0].date, "YYYY-MM-DD HH:mm").fromNow() );
			$copy.find('span.preview').html( Th.msgs[0].msg.substring( 0, 40) + '<span class="badge">'+ ((Th.unreds>0) ? Th.unreds : '') +'</span>'  );		
		}
		
		
		
		
		//if( Th.unreds > 0 ) ChatsNew++;
		if( Th.unreds > 0 ){
			ChatsNew+= Th.unreds;
		}
		
		
		if(empty(Th.image1)){
			$copy.find('img').prop('src', 'images/no-pic3.jpg');		
		}else{
			$copy.find('img').prop('src', 'http://mobileapi.foodiesys.com/foodie-mssql/pics/'+Th.image1 );
		}

		$copy.appendTo('#dataList');
	}
	localStorage.setItem('ChatsNew', ChatsNew);
	showChatConvCount();
}



function openChatWindow( chatIndex ){
	
	if( !empty(chatIndex) || chatIndex == '0'  ){
		
		ActiveChatIndex = chatIndex;
		
		console.log('xxxxxxxxxxxx'+ActiveChatIndex);
		console.log(chatData);
		console.log('xxxxxxxxxxxx');
		
		$('#spMsgs').html('');	
		
		console.log(chatData[ActiveChatIndex].msgs);
		if(!empty(chatData[ActiveChatIndex].msgs)){
			for( var i = 0; i < chatData[ActiveChatIndex].msgs.length; i++ ) {
				var T = chatData[ActiveChatIndex].msgs[i];
				console.log(T);
				var cls = (T.dir == 'out')?'me':'you'; 
				var H = '<div class="bubble '+cls+'">'+T.msg+'</div>';
				$('#spMsgs').prepend(H);			
			}
		}
		
		// mark all messages red ---------
		if( chatData[ActiveChatIndex].unreds > 0 ){
			var formData = {	userId: localStorage.getItem('userId'), userToken: localStorage.getItem('userToken'), opponent:chatData[ActiveChatIndex].id, maxId:chatData[ActiveChatIndex].msgs[0].mid  };
			$.ajax({
				type: "POST", dataType: 'json', url: ServerAjax+"?h=setChatMsgsRed", data: formData,
				//beforeSend: function() { waitingDialog.show(cLan.Loading, {dialogSize: 'sm', progressType: 'info'}); },
				//complete: function() { waitingDialog.hide(); },
				}).fail(  ajaxError
				).done(function(data){
					if (data.Success == 'true') {
						chatData[ActiveChatIndex].unreds = 0;
						//localStorage.setItem('ChatsNew', n);
						loadChatLeft();
					} else { 
					}
					if (data.JS) { eval(data.JS); }
			}); // ajax		
		}
		//------ mark red -----------------
				
				
		//$("html, body").animate({ scrollTop: $(document).height() }, 1);
		$('#chatWinName').html(chatData[ActiveChatIndex].name);
		$('div.left').hide();
		$('div.right').show();
		
		$("html, body").animate({ scrollTop: $(document).height() }, 500);
		
		//setTimeout(function(){ 
		//document.location = document.location + '#goLast';
		// }, 500);
		
		
	}
}


</script>
</body>
</html>