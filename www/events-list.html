<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Fudi</title>

<!-- Sets initial viewport load and disables zooming  -->
<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, width=device-width" />

<!-- Makes your prototype chrome-less once bookmarked to your phone's home screen -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="mobile-web-app-capable" content="yes">
<link href="css/bootstrap.min.css" rel="stylesheet">
<link href="css/font-awesome.min.css" rel="stylesheet">
<link href="css/styles.css" rel="stylesheet">
<style>
.nav-tabs li{ width:auto; }
.nav-tabs li{ display:inline-block; }
/*.nav-tabs a, .nav-tabs .active > a{ font-size:15px !important;  }*/
.nav-tabs>li>a{ border:none; }
h4.names_label label{ font-weight: normal !important; margin:3px 5px }


</style>
</head>
<body id="wrapper">
<div id="sidebar-wrapper">
	<nav id="nav">
		<ul class="sidebar-nav nav" id="navRight">
			<li class="L0 menu-heading"><strong><a href="#"><i class="icon-user"></i> <span data-bind="text: lang.Fudi"></span></a></strong></li>
			<li class="L2"><a class="sub" href="map.html"><i class="icon-pointer-advice"></i> <span data-bind="text: lang.mnuChefs"></span></a></li>
			<li class="L2"><a class="sub" href="user-profile.html"><i class="icon-user"></i> <span data-bind="text: lang.MyProfile"></span></a></li>
			<li class="L2"><a class="sub" href="payment-options.html"><i class="icon-credit-cards"></i> <span data-bind="text: lang.PO"></span></a></li>
			<li class="L2"><a class="sub" href="reservations.html"><i class="icon-tray"></i> <span data-bind="text: lang.MyOrders"></span></a></li>
			
			<li class="L2"><a class="sub" href="events-list.html"><i class="fa fa-glass"></i> <span data-bind="text: lang.Events"></span></a></li>
			<li class="L0 menu-heading"><strong><a href="#"><i class="icon-chef"></i> <span data-bind="text: lang.CHEF"></span></a></strong></li>
			<li class="L2 noChef"><a class="sub" href="chef-profile-edit.html"><i class="icon-chef"></i> <span data-bind="text: lang.BecomeaChef"></span></a></li>
			<li class="L2 isChef pChef"><a class="sub" href="chef-profile-edit.html"><i class="icon-chef"></i> <span data-bind="text: lang.ChefProfile"></span></a></li>
			<li class="L2 isChef"><a class="sub" href="chef-dishes.html"><i class="icon-food"></i> <span data-bind="text: lang.ManageDishes"></span></a></li>
			<li class="L2 isChef"><a class="sub" href="chef-calendar-set.html"><i class="icon-clock"></i> <span data-bind="text: lang.Schedule"></span></a></li>
			<li class="L2 isChef"><a class="sub" href="delivery-schedule.html"><i class="icon-calendar"></i> <span data-bind="text: lang.DeliverySchedule"></span></a></li>
			<li class="L2 isChef"><a class="sub" href="ps-schedule.html"><i class="icon-calendar-1"></i> <span data-bind="text: lang.PSmenu"></span></a></li>
			<li class="L2 isChef"><a class="sub" href="chef-reservations.html"><i class="icon-reserve"></i> <span data-bind="text: lang.ChefReservations"></span></a></li>
			<li class="L2 isChef"><a class="sub" href="chef-events.html"><i class="fa fa-glass"></i> <span data-bind="text: lang.eventResv"></span></a></li>
			<li class="L2 isChef"><a class="sub" href="withdraw-money-chef.html"><i class="icon-withdraw"></i> <span data-bind="text: lang.WithdMon"></span></a></li>
			<li class="L1"><a href="chat.html"><i class="fa fa-comments"></i> <span data-bind="text: lang.Chat"></span></a></li>
			<li class="L1"><a href="settings.html"><i class="icon-gear"></i> <span data-bind="text: lang.Settings"></span></a></li>
			<li class="L1"><a href="about.html"><i class="icon-about"></i> <span data-bind="text: lang.AboutFudi"></span></a></li>
			<li class="L1"><a href="register.html?do=logout"><i class="icon-logout"></i> <span data-bind="text: lang.Logout"></span></a></li>
		</ul>
	</nav>
</div>
<h1 id="menu-button"> <a id="menu-toggle" href="#" class="btn-menu toggle"> <i class="fa fa-bars"></i> </a>
	<p class="pageTitle" xdata-bind="text: lang.ManageD">Events</p>
</h1>
<!-- Wrap all non-bar HTML in the .content div (this is actually what scrolls) -->
<div class="container">
	<div id="chef-page" class="content">
		
		
		
		<div class="row main-div main-div_ex ">
		<div class="col-xs-12 tabs-bg">
					
					
					<ul class="eventTabs">
						<li style="width:38%" class="active"><a data-toggle="tab" href="#tab_nearby" class="tab_border" xdata-bind="text: lang.AboutChef">Events Near Me</a></li>
						<li style="width:30%"><a data-toggle="tab" xdata-bind="text: lang.Dishes" href="#tab_attending">Attending</a></li>
						<li style="width:32%"><a data-toggle="tab" xdata-bind="text: lang.Dishes" href="#tab_my">My Events</a></li>
					</ul>
					
					
					<div class="tab-content">
						<div id="tab_nearby" class="tab-pane fade in active"> 
							<p class="help-block text-center"><br>No Events Found!</p>
						</div>
						<div id="tab_attending" class="tab-pane fade"> 
							<p class="help-block text-center"><br>No Events Found!</p>
						</div>
						<div id="tab_my" class="tab-pane fade"> 
							<div class="text-center" style="margin:10px 0">
							<button class="btn btn-sm btn-primary  btnShowAdd"><i class="fa fa-plus-circle"></i> <span xdata-bind="text: lang.AddNew">Create Event</span></button>
							<button id="btnScan" class="btn btn-sm btn-primary"><i class="fa fa-qrcode"></i> &nbsp; <span xdata-bind="text: lang.ScanQR">Scan QR Code</span></button>
							<p class="help-block text-center"><br>No Events Found!</p>
							</div>
						</div>
					</div>
				</div>
		</div>
		
		
		
		
		
		
		
		
		
		
		
		<div id="chef-foods">
		<div class="food-listing hidden">
			<div class=" col-xs-12 no-lft-padding no-right-padding">
				<div class="food-info-body">
					<h4 class="dishTitle">...</h4>
					
					<div class="byChef" style="line-height:1.7em">..</div>
					<div class="evCtrls" style="margin-top:15px"></div>
				</div>
			</div>
		</div>
		<div class="aLoading text-center" style="display:none"><img src="images/loading.gif" sytle=" margin: 0 auto;" /></div>
	</div>
		
		
		
	</div>
</div>
<br />
<br />
<br />

<div class="modal fade" id="popPSOrder" tabindex="-1" role="dialog" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
				<h4 class="modal-title" xdata-bind="text: lang.DeliveryOrder">Join Event</h4>
			</div>
			<div class="modal-body">
				<form method="post" id="frmReserve3">
					<div id="divCheckList">
					
					</div>
					<h4 style="color:#666;" id="h4Ad"><span xdata-bind="text: lang.Deliverycharges2">Entry Charges</span> : <span id="PS_Adcharges">$0.00</span></h4>
					<h2 style="color:#C00"><span data-bind="text: lang.Total">Total</span> : <span id="d_total">$40.00</span></h2>
				</form>
			</div>
			<div class="modal-footer">
				<button id="btnStartPay" type="button" class="btn btn-primary" xdata-bind="text: lang.OrderNow">Join Now!</button>
			</div>
		</div>
	</div>
</div>


<div class="modal fade" id="popEditEvent" tabindex="-1" role="dialog" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
				<h4 class="modal-title" xdata-bind="text: lang.DeliveryOrder">Edit Event</h4>
			</div>
			<div class="modal-body">
				<form method="post" id="frmEditEvent">
					<div class="form-group">
						<label xdata-bind="text: lang.PSAPH">Event Title</label>
						<div>
							<input class="form-control required" type="text" name="ed_event_title" id="ed_event_title" value=""  />
						</div>
					</div>
					
					<div class="form-group">
						<label >Event Description</label>
						<div>
							<textarea class="form-control " name="ed_description" id="ed_description"></textarea>
						</div>
					</div>
					
					
					<div class="form-group">
						<label _data-bind="text: lang.PSAPH">Entrance Fee</label>
						<div class="input-group">
							<div class="input-group-addon">$</div>
							<input class="form-control required" type="number" name="ed_entry_fee" id="ed_entry_fee" value="0.00" />
						</div>
					</div>
					<input type="hidden" name="edit_id" id="edit_id" />
					
				</form>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal" xdata-bind="text: lang.Cancel">Cancel</button>
				<button type="button" id="ed_Save" class="btn btn-primary" xdata-bind="text: lang.OrderNow">Save</button>
			</div>
		</div>
	</div>
</div>


<br />
<br />
<br />
<div class="modal fade" id="popDetail" tabindex="-1" role="dialog" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
				<h4 class="modal-title" xdata-bind="text: lang.AdEdDish">Event Details</h4>
			</div>
			<div class="modal-body">
				
					<div id="infoDiv">
					
					</div>
				
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal" xdata-bind="text: lang.Cancel">Close</button>
				<button id="btnAdd" type="button" class="btn btn-primary" xdata-bind="text: lang.Save">Join This Event!</button>
			</div>
		</div>
	</div>
</div>

<div class="modal fade" id="popPermission" tabindex="-1" role="dialog" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
				<h4 class="modal-title" xdata-bind="text: lang.AdEdDish">Permission Required</h4>
			</div>
			<div class="modal-body">
				
				<p>This event is private and cannot be viewed by everyone. If you are interested, click the button below to ask event organizer for access.</p>
				
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal" xdata-bind="text: lang.Cancel">Close</button>
				<button id="btnAskPermission" type="button" class="btn btn-primary" xdata-bind="text: lang.Save">Request Access</button>
			</div>
		</div>
	</div>
</div>

<div class="modal fade" id="popUsers" tabindex="-1" role="dialog" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
				<h4 class="modal-title" xdata-bind="text: lang.AdEdDish">Event Users</h4>
			</div>
			<div class="modal-body">
				
				<div id="spUsersBody"></div>
				
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal" xdata-bind="text: lang.Cancel">Close</button>
			</div>
		</div>
	</div>
</div>

<div class="modal fade" id="popLevel2" tabindex="-1" role="dialog" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
				<h4 class="modal-title" xdata-bind="text: lang.AdEdDish">Order Details</h4>
			</div>
			<div class="modal-body">
				
				<div id="popLevel2Body"></div>
				
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal" xdata-bind="text: lang.Cancel">Close</button>
			</div>
		</div>
	</div>
</div>

<!-- Script --> 
<script type="text/javascript" src="cordova.js"></script> 
<script src="js/jquery-1.11.3.min.js"></script> 
<script src="js/bootstrap.min.js"></script> 
<script src="js/jquery.validate.min.js"></script>
<script src="js/moment.min.js"></script>
<script src="js/jquery.qrcode.js"></script> 
<script src="js/qrcode.js"></script> 
<script src='js/knockout-3.4.0.js'></script> 
<script src="js/common.js"></script> 
<script>

var thisEvent;
var thisEventIndex;
var eventData;
var delId = false;
var quietLoad = false;
var Total = 0.0; 

$(document).ready(function(e) {
	
	
	loadPageData();
	
	var url = document.location.toString();
	if (url.match('#')) {
		$('.eventTabs a[href="#' + url.split('#')[1] + '"]').tab('show');
	} 
	
	
	$('#btnAdd').on('click',function(){ // Join button on event detail popup
		
		// check if user profie is complete
		var user_profile_complete = false;
		if( !empty(localStorage.getItem('userData'))){
			var userData = JSON.parse(localStorage.getItem('userData'));
			if( !empty(userData.first_name) && !empty(userData.last_name) && !empty(userData.phone)  ){
				user_profile_complete = true;	
			}
		}
		if( user_profile_complete == false ){
			BAlert.find('.modal-header h3').html('<i class="fa fa-exclamation-triangle"></i> '+cLan.Error);
			BAlert.find('.modal-body').html('<p class="text-danger">'+cLan.Pleasetap+' <a href="user-profile.html?RetPage='+encodeURI('events-list.html')+'">'+cLan.HERE+'</a> '+cLan.tocompleteprofile+'</p>');
			BAlert.modal();
			return false;
		} 
		
		
		var H = '';
		$('#PS_Adcharges').html('$'+thisEvent.entry_fee);
		$('#d_total').html('$'+thisEvent.entry_fee);
		
		H += '<div class="alert alert-info">Please select dishes you would like to eat on event "'+thisEvent.title+'"</div>';
		var I = loadDishes();
		$('#divCheckList').html(H+I);
		$('#popDetail').modal('hide');
		$('#popPSOrder').modal();
		console.log(thisEvent);
	});
	
	
	$('#btnAskPermission').on('click', function(){

		var formData = {
			userId: localStorage.getItem('userId'),
			userToken: localStorage.getItem('userToken'),
			eventId : thisEvent.id };
			
		$.ajax({
			type: "POST", dataType: 'json', url: ServerAjax+"?h=eventPermission", data: formData,
			beforeSend: function() { waitingDialog.show(cLan.Loading, {dialogSize: 'sm', progressType: 'info'}); },
			complete: function() { waitingDialog.hide(); },
			}).fail(  ajaxError
			).done(function(data){
				if (data.Success == 'true') {
					$('#popPermission').modal('hide');
					BAlert.find('.modal-header h3').html('<i class="fa check"></i>'+cLan.Success);
					BAlert.find('.modal-body').html('<p class="text-success">'+'Permission request has been sent to event organizer.'+'</p>');
					BAlert.modal();
					
					loadPageData();
					
				} else { 
					ErrorModalWithParm(data);
				}
				if (data.JS) { eval(data.JS); }
			
		}); // ajax	
	
	});
	
	$('#spUsersBody').on('click', '.btnAllowDeny',function(){
		
		var AD = $(this).hasClass('btnAllow')?'A':'D';
		var formData = {
				userId: localStorage.getItem('userId'),
				userToken: localStorage.getItem('userToken'),
				allowUser: $(this).data('id'),
				eventId: thisEvent.id,
				access: AD
			};
		
		var TD = $(this).closest('td');
		TD.html('<img src="images/wait.gif" />');
				 
		$.ajax({
			type: "POST", dataType: 'json', url: ServerAjax+"?h=allow4Event", data: formData, context: TD
			//beforeSend: function() {  },
			//complete: function() { waitingDialog.hide(); },
			}).fail(  ajaxError
			).done(function(data){
				if (data.Success == 'true') {
				
					if( data.access == 'A' ){
						$(this).html('<i class="fa green fa-check-circle fa-2x"></i>');
					}else{
						$(this).html('<i class="fa red fa-times-circle fa-2x"></i>');
					}
					
					if(!empty(eventData[thisEventIndex].user_data)){
						var ud = JSON.parse(eventData[thisEventIndex].user_data);	
						for (var i = 0; i < ud.length ; i++){
							if(ud[i].id == data.allowUser){
								ud[i].access = data.access;
								eventData[thisEventIndex].user_data = JSON.stringify(ud);
							}
						}
					}
					
				
				} else { 
					ErrorModalWithParm(data);
				}
				if (data.JS) { eval(data.JS); }
			
		}); // ajax	
		
	});	

	$('.tab-content').on('click', '.btnQR',function(){
		BAlert.find('.modal-header h3').html('<i class="fa check"></i> '+cLan.QRCode);
		BAlert.find('.modal-body').html('').qrcode({ text: $(this).data('qr') });
		BAlert.modal();
	});
	
	$('.tab-content').on('click', '.btnUsers',function(){
		
		var id = $(this).data('id');
		
		for (var i = 0; i < eventData.length; i++){
			if( eventData[i].id == id ){
				thisEvent = eventData[i];
				thisEventIndex = i;
				break;
			}
		}
		var H = '';
		
		H += '<div class="table-responsive noBorder"><table class="table">';
		H += '<tr class="info"><td ><strong>Users</strong> </td><td ><strong>Allow/Deny</strong></td></tr>';
		if(!empty(thisEvent.user_data)){
			var ud = JSON.parse(thisEvent.user_data);	
			console.log(ud);
			for (var i = 0; i < ud.length ; i++){
				H += '<tr><td>'+ud[i].first_name+' '+ud[i].last_name+'<br>'+ud[i].email+'</td>'; //<td class="text-center"><button type="button" class="btn btn-info btn-sm btnAllow btnAllowDeny" data-id="'+ud[i].id+'">Allow</button> <button type="button" class="btn btn-info btn-sm btnDeny btnAllowDeny" data-id="'+ud[i].id+'">Deny</button></td></tr>';
				
				if( empty(ud[i].access) || ud[i].access == 'P' ) H += '<td class="text-center"><button type="button" class="btn btn-info btn-sm btnAllow btnAllowDeny" data-id="'+ud[i].id+'">Allow</button> <button type="button" class="btn btn-info btn-sm btnDeny btnAllowDeny" data-id="'+ud[i].id+'">Deny</button></td></tr>';
				else if( ud[i].access == 'A' ) H += '<td class="text-center"><i class="fa green fa-check-circle fa-2x"></i></td></tr>';
				else if( ud[i].access == 'D' ) H += '<td class="text-center"><i class="fa red fa-times-circle fa-2x"></i></td></tr>';
					
				
			}
		}
		H += '</table></div>';
		
		$('#spUsersBody').html(H);
		$('#popUsers').modal();
	});
		
	$('.tab-content').on('click', '.btnSelect',function(){ // view details
		var id = $(this).data('id');
		
		for (var i = 0; i < eventData.length; i++){
			if( eventData[i].id == id ){
				thisEvent = eventData[i];
				thisEventIndex = i;
				break;
			}
		}
		
		
		var event_owner = (thisEvent.creator_id == localStorage.getItem('userId'));
		
		if( thisEvent.availability == 'Private' && !event_owner  ){
			if( thisEvent.access == 'D'){
				BAlert.find('.modal-header h3').html('<i class="fa fa-exclamation-triangle"></i> '+cLan.Error);
				BAlert.find('.modal-body').html('<p class="text-danger">Sorry, access denied by the event organizer.</p>');
				BAlert.modal();
				return false;
			}
			
			if( thisEvent.access != 'A' ){
				$('#popPermission').modal();
				return false;
			} 
		}
		
		
		document.location = 'event-view.html?eventid='+id;
		return;
	
	});
	
	
	$(document).on('click', 'a.aRightArrow', function(){
		var i = $(this).data('userindex');
		 
		var H = 'Guest Name: <strong>'+thisEvent.Users[i].first_name+' '+thisEvent.Users[i].last_name+'</strong>';
		
		
				
		H += '<h4>Order Details</h4>';
		H += '<table class="table table-responsive table-striped">';
		H += '<tr><th>Dish Name</th><th>Chef Price</th><th>Qty</th><th>Event Price</th></tr>';
		var order_data = JSON.parse( thisEvent.Users[i].order_data );
		var owner_got = 0;
		for (var j = 0; j < order_data.length ; j++){
			H += '<tr><td>'+order_data[j].name+'</td><td>$'+order_data[j].price+'</td><td>'+order_data[j].qty+'</td><td>$'+order_data[j].eventPrice+'</td></tr>';
			owner_got += Math.max( (parseFloat(order_data[j].eventPrice)-parseFloat(order_data[j].price)) * parseInt(order_data[j].qty), 0 );
		}
		H += '<tr><th></th><th colspan="2">Entry Fee</th><th>$'+thisEvent.Users[i].entry_amount+'</th></tr>';
		H += '<tr><th></th><th colspan="2">User Paid</th><th>$'+thisEvent.Users[i].user_amount+'</th></tr>';
		
		if( thisEvent.Users[i].owner_amount > 0 ){
			H += '<tr><th></th><th colspan="2">You Paid</th><th class="red">$'+thisEvent.Users[i].owner_amount+'</th></tr>';
		}else{
			H += '<tr><th></th><th colspan="2">You Earn</th><th class="green">+$'+ owner_got.toFixed(2) +'</th></tr>';	
		}
		
		H += '</table>';
		
		if(empty(thisEvent.Users[i].qr_scan_date)){
			H += 'QR Scan: <span class="red">Not yet</span>';		
		}else{
			var mo = moment( thisEvent.Users[i].qr_scan_date, 'YYYY-MM-DD HH:mm:ss' );
			H += 'QR Scan Date: <span class="green">'+ mo.format('MMM D, YYYY (ddd) h:mma')+'</span>' ;			
		}
		
		$('#popLevel2Body').html( H );
		$('#popLevel2').modal();
		
	});
	
	$('#btnStartPay').on('click',function(){
		if( $('#divCheckList input:checked').length == 0 ){
			BAlert.find('.modal-header h3').html('<i class="fa fa-exclamation-triangle"></i> '+cLan.Error);
			BAlert.find('.modal-body').html('<p class="text-danger">Please select atleast one dish to proceed.</p>');
			BAlert.modal();
			return;
		}
		
		var dishes = [];
		var Total = 0.00;
		$('#divCheckList [type=checkbox]').each(function(index, element) {
			if($(this).is(':checked')){
				qty = $('#aQty'+$(this).val()).val();
				dishes.push( {'id':$(this).val(), 'chef_id': $(this).data('chef_id'), 'name': $(this).data('name'), 'qty':qty,'price': $(this).data('price'), 'eventPrice': $(this).data('eventprice') } ); 
				Total = Total + parseFloat($(this).data('eventprice')) * parseInt(qty); 
			}	
		});
		Total +=  parseFloat(thisEvent.entry_fee); 

		var formData = { 	'event_id' : thisEvent.id,
								'userId' : localStorage.getItem('userId'),
								'userToken' : localStorage.getItem('userToken'),
								'dishes' : dishes,
								'amount' : Total,
								'entry_fee' : thisEvent.entry_fee 
							};

		console.log(formData);
		//return false;
		
		//formData += '&userToken=' + localStorage.getItem('userToken');
		$.ajax({
			type: "POST", dataType: 'json', url: ServerAjax+"?h=joinEvent", data: formData,
			beforeSend: function() { waitingDialog.show(cLan.Loading, {dialogSize: 'sm', progressType: 'info'}); },
			complete: function() { waitingDialog.hide(); },
			}).fail(  ajaxError
			).done(function(data){
				if (data.Success == 'true') {
					
					
					if( data.Complete == 'true' ){ // nothing to pay, 
						document.location = 'events-list.html?r='+Math.random()+'#tab_attending';	
					}
					
					if(!empty(data.EvTransId)){ // user have to pay his amount 
						document.location = 'payment-options-select.html?Type=EventJoin&ResId='+data.EvTransId+'&Amount='+Total+'&EvTransId='+data.EvTransId;
					}
					
					
					//document.location = 'payment-options-select.html?Type=Event&ResId='+data.joinId+'&Amount='+Total;
					
				} else { 
					ErrorModalWithParm(data);
				}
				if (data.JS) { eval(data.JS); }
			
		}); // ajax	
		
		
		
	});
	
	
	
	$('.btnShowAdd').on('click',function(){
		document.location = 'event-1.html';
	});
	
	/*
	$('#frmReserve').validate({
		errorPlacement: function(error, element) {},
		submitHandler: function(form) {
			
			var Flag = 0;
			if( $('#chkAV1').prop('checked') == true )  Flag = Flag | 1;
			if( $('#chkAV2').prop('checked') == true )  Flag = Flag | 2;
			if( $('#chkAV4').prop('checked') == true )  Flag = Flag | 4;
			$('#hdAvailability').val(Flag);
			
			
			formData = $(form).serialize();
			formData += '&userToken=' + localStorage.getItem('userToken');
			$.ajax({
				type: "POST", dataType: 'json', url: ServerAjax+"?h=addEditDish", data: formData,
				beforeSend: function() { waitingDialog.show(cLan.Loading, {dialogSize: 'sm', progressType: 'info'}); },
				complete: function() { waitingDialog.hide(); },
				}).fail(  ajaxError
				).done(function(data){
					if (data.Success == 'true') {
						$('#popDetail').modal('hide');
						BAlert.find('.modal-header h3').html('<i class="fa check"></i>'+cLan.Success);
						BAlert.find('.modal-body').html('<p class="text-success">'+cLan['202']+'</p>');
						BAlert.modal();
						quietLoad = true;
						loadDishes(chef_id);
						//loadDishes(localStorage.getItem('userId'));
					} else { 
						ErrorModalWithParm(data);
					}
					if (data.JS) { eval(data.JS); }
				
			}); // ajax	
		
		}// submit handler
	});
	*/
	
	$('#divCheckList').on('change', 'input',function(){
		if( $(this).is(':checked')){
			$(this).parent('li').find('.spDishD').show(200);
		}else{
			$(this).parent('li').find('.spDishD').hide(150);	
		}
		getTotal();
	});
	
	
	$('#btnScan').on('click',function(){
		try{
			cordova.plugins.barcodeScanner.scan(QRonSuccess, QRFailure);
		}catch(err) {
			BAlert.find('.modal-header h3').html('<i class="fa fa-exclamation-triangle"></i> '+cLan.Error);
			BAlert.find('.modal-body').html('<p class="text-danger">'+cLan.UnableQR+'</p>');
			BAlert.modal();	
		}
	});
	
	
	$('#tab_my').on('click','.btnEdit',function(){
		var editId = $(this).data('evid');
		$('#edit_id').val(editId);
		
		for (var i = 0; i < eventData.length; i++) {
			if( editId == eventData[i].id ){
				$('#ed_event_title').val(eventData[i].title);
				$('#ed_description').val(eventData[i].description);
				$('#ed_entry_fee').val(eventData[i].entry_fee);
				$('#popEditEvent').modal();
				return;
			}
		}
	});
	
	$('#tab_my').on('click','.btnDel',function(){
		var delId = $(this).data('evid');
		
		var DLGConfirm = $('<div class="modal fade" tabindex="-1" role="dialog" aria-hidden="true" style="padding-top:15%; overflow-y:visible;">' +
		'<div class="modal-dialog modal-md"><div class="modal-content">' +
			'<div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>' +
			'<h3 style="margin:0;">Delete Event</h3></div><div class="modal-body"><p>Are you sure you want to delete this event?</p></div>' +
			'<div class="modal-footer"><button type="button" class="btn confirm btn-danger" data-dismiss="modal">'+cLan.Delete+'</button><button type="button" class="btn" data-dismiss="modal">'+cLan.Cancel+'</button></div>'+
		'</div></div></div>');
		DLGConfirm.find('.confirm').on('click',function(e){
			if(!empty(delId)){
				var formData = {
					userId: 		localStorage.getItem('userId'),
					userToken: 	localStorage.getItem('userToken'),
					event_id:	delId,
				};
				$.ajax({
					type: "POST", dataType: 'json', url: ServerAjax+"?h=deleteEvent", data: formData,
					beforeSend: function() { waitingDialog.show(cLan.Loading, {dialogSize: 'sm', progressType: 'info'}); },
					complete: function() { waitingDialog.hide(); },
					}).fail(  ajaxError
					).done(function(data){
						if (data.Success == 'true') {
							
							BAlert.find('.modal-header h3').html('<i class="fa check"></i>'+cLan.Success);
							BAlert.find('.modal-body').html('<p class="text-success">Event has been deleted successfully </p>');
							BAlert.find('.btn-primary').on('click',function(){
								$(this).off();
								$('#popEditEvent').modal('hide');
								loadPageData();
							});
							
							BAlert.modal();
							
						} else { 
							ErrorModalWithParm(data);
						}
						if (data.JS) { eval(data.JS); }
				}); // ajax	
			}
				
		});
		DLGConfirm.modal();
		
		
	});
	
	

	$('#ed_Save').on('click',function(){
		$("#frmEditEvent").submit();		
	});
	
	$("#frmEditEvent").validate({
		errorPlacement: function(error, element) {},
		submitHandler: function(form) {
		
			var formData = {
				userId: 		localStorage.getItem('userId'),
				userToken: 	localStorage.getItem('userToken'),
				title: 		$('#ed_event_title').val(),
				description:$('#ed_description').val(),
				event_id:	$('#edit_id').val(),
				entry_fee:	$('#ed_entry_fee').val() 
			};
			
			$.ajax({
				type: "POST", dataType: 'json', url: ServerAjax+"?h=editEvent", data: formData,
				beforeSend: function() { waitingDialog.show(cLan.Loading, {dialogSize: 'sm', progressType: 'info'}); },
				complete: function() { waitingDialog.hide(); },
			}).fail(  ajaxError )
			.done(function(data){
				if (data.Success == 'true') {
					//EventId, EventOrderId, EventScanDate
					BAlert.find('.modal-header h3').html('<i class="fa check"></i>'+cLan.Success);
					BAlert.find('.modal-body').html('<p class="text-success">Event has been updated successfully </p>');
					BAlert.find('.btn-primary').on('click',function(){
						$(this).off();
						$('#popEditEvent').modal('hide');
						loadPageData();
					});
					
					BAlert.modal();
					
					/*
					for (var i = 0; i < eventData.length; i++){
						if( eventData[i].id == data.EventId ){
							for (var j = 0; j < eventData[i].Users.length; j++){
								if( eventData[i].Users[j].id == data.EventOrderId ){
									eventData[i].Users[j].qr_scan_date = data.EventScanDate;
									break;								
								}
							}
							break;
						}
					}
					SuccessModalWithParm(data);
					*/
					
				} else { 
					ErrorModalWithParm(data);
				}
				if (data.JS) { eval(data.JS); }
			
			}); // ajax	
		
		}
	});

});

function QRonSuccess(result){
	
	if( result.cancelled == true ){
		return false; 	
	}				 
	var code = result.text;
	if(code.charAt(0) == 'F'){
		code = code.substr(1);	 // Remove F
		code = code.split(':');
		var id = parseInt(code[0]);
		var key = parseInt(code[1]);
		if(empty(id) || empty(key)){
			BAlert.find('.modal-header h3').html('<i class="fa fa-exclamation-triangle"></i> '+cLan.Error);
			BAlert.find('.modal-body').html('<p class="text-danger">'+cLan.InvalidQR+'</p>');
			BAlert.modal();		
		}else{
		
			var formData = {
				userId: localStorage.getItem('userId'),
				userToken: localStorage.getItem('userToken'),
				Fcode: key
			};
			$.ajax({
				type: "POST", dataType: 'json', url: ServerAjax+"?h=eventQRScan", data: formData,
				beforeSend: function() { waitingDialog.show(cLan.Loading, {dialogSize: 'sm', progressType: 'info'}); },
				complete: function() { waitingDialog.hide(); },
			}).fail(  ajaxError )
			.done(function(data){
				if (data.Success == 'true') {
					//EventId, EventOrderId, EventScanDate
					
					for (var i = 0; i < eventData.length; i++){
						if( eventData[i].id == data.EventId ){
							for (var j = 0; j < eventData[i].Users.length; j++){
								if( eventData[i].Users[j].id == data.EventOrderId ){
									eventData[i].Users[j].qr_scan_date = data.EventScanDate;
									break;								
								}
							}
							break;
						}
					}
					
					SuccessModalWithParm(data);
					
				} else { 
					ErrorModalWithParm(data);
				}
				if (data.JS) { eval(data.JS); }
			
			}); // ajax	
		
		
			
		}
	}else{
		BAlert.find('.modal-header h3').html('<i class="fa fa-exclamation-triangle"></i> '+cLan.Error);
		BAlert.find('.modal-body').html('<p class="text-danger">'+cLan.InvalidQR+'</p>');
		BAlert.modal();	
	} 
}
function QRFailure(message){
	BAlert.find('.modal-header h3').html('<i class="fa fa-exclamation-triangle"></i> '+cLan.Error);
	BAlert.find('.modal-body').html('<p class="text-danger">'+cLan.UnableQR+': '+message+'</p>');
	BAlert.modal();	
}

function getTotal(){
	Total = 0.00;
	$('#divCheckList [type=checkbox]').each(function(index, element) {
		if($(this).is(':checked')){
			Total = Total + $(this).data('eventprice') * $('#aQty'+$(this).val()).val(); 
		}	
	});
	Total +=  parseFloat(thisEvent.entry_fee); 
	$('#d_total').html('$'+Total.toFixed(2));
}

function loadPageData(){
	var formData = {
				userId: localStorage.getItem('userId'),
				userToken: localStorage.getItem('userToken'), 
				lat: localStorage.getItem('lat'),
				lng: localStorage.getItem('lng') };
				
	$.ajax({
		type: "POST", dataType: 'json', url: ServerAjax+"?h=getEvents", data: formData,
		beforeSend: function() { $('div.aLoading').show();  },
		complete: function() { $('div.aLoading').hide(); },
	}).fail(  ajaxError )
	.done(function(data){
		if (data.Success == 'true') {
			if(!empty(data.Events)){
				eventData = data.Events;
				
				$('div.food-listing').not('.hidden').remove();
				
				$DTemp = $('.food-listing');
				for (var i = 0; i < eventData.length; i++) {
					$copy = $DTemp.clone().removeClass('hidden');
					$copy.addClass( 'ID'+eventData[i].id );
					$copy.find('img.img-responsive').prop('src', 'http://mobileapi.foodiesys.com/foodie-mssql/pics/'+eventData[i].image1);
					$copy.find('h4.dishTitle').html( eventData[i].title );
					
					var event_owner = (eventData[i].creator_id == localStorage.getItem('userId'));
					
					var T = '';
					
					//eventData[i].description = 'At vero eos et accusamus et iusto odio dignissimos ducimus qui blanditiis praesentium voluptatum deleniti atque';
					
					if(!empty(eventData[i].description)){
						T += '<div class="eventDesc">'+eventData[i].description.substring(0,80)+'</div>';	
					}
					
					var mo = moment( eventData[i].event_date+' '+eventData[i].event_time, 'YYYY-MM-DD HH:mm:ss' );
					T += '<div><i class="fa fa-clock-o colorGrey"></i>&nbsp; '+ mo.format('MMM D, YYYY (ddd) [at] h:mma') +'</div>';
					
					
					var Dst = distance( localStorage.getItem('lat'), localStorage.getItem('lng'), eventData[i].lat, eventData[i].lng, 'M');
					
					T += '<i class="fa fa-car colorGrey"></i> &nbsp;';
					if( eventData[i].availability == 'Private' ){
						var Dst5 =  Math.ceil(Dst/5)*5;
						T += '<span>About '+Dst5+' miles away</span>';
					}else{
						T += '<span>'+Dst.toFixed(1)+' miles away</span>';	
					}
					T += ' <em>('+eventData[i].availability+' Event)</em>';
					
					T += loadDishes(eventData[i]);
					
					$copy.find('.evCtrls').append('<button type="button" class="btn btn-warning btn-sm btnSelect " data-id="'+eventData[i].id+'">View Details</button> ');
					
					if( event_owner == true && eventData[i].availability == 'Private'  ){
						$copy.find('.evCtrls').append('<button type="button" class="btn btn-info btn-sm  btnUsers" data-id="'+eventData[i].id+'">User Access</button> ');
					}
					
					
					if(!empty(eventData[i].Attending )){ // Attending, add QR code button
						var QRCode = '';
						if( !empty(eventData[i].Users)){
							for(var k=0; k < eventData[i].Users.length; k++ ){
								if( eventData[i].Users[k].user_id == localStorage.getItem('userId') ){
									QRCode = eventData[i].Users[k].qr_code;	
								}	
							}	
						}
						if(!empty(QRCode)){
							$copy.find('.evCtrls').append('<button class="btn btn-sm btnQR btn-info" data-qr="F'+eventData[i].id+':'+QRCode+'"><i class="fa fa-qrcode"></i> QR Code</button> ');	
						}
					}
					
					$copy.find('div.byChef').html( T );
					var mo = moment(eventData[i].event_date, 'YYYY-MM-DD HH:mm:ss');
					//event_owner = true; // TESTAPP
					var inTab = '';
					if( event_owner == true ){ // I m the creator
						//T += '<div style="margin-top:5px">'+
						//			'<button data-evid="'+eventData[i].id+'" class="btn fbtn btnEdit btn-warning"><i class="fa fbtn fa-pencil" title="Edit" aria-hidden="true"></i></button> &nbsp;'+
						//			'<button data-evid="'+eventData[i].id+'" class="btn fbtn btnDel btn-danger"><i class="fa fbtn fa-trash-o" title="Delete" aria-hidden="true"></i></button>'+
						//		'</div>';
						if( mo.isAfter(moment()) || mo.isSame(moment(),'day')  ){ // Today or evetn in future
							$copy.find('.evCtrls').append('<button data-evid="'+eventData[i].id+'" class="btn  btnEdit btn-warning"><i class="fa fbtn fa-pencil" title="Edit" aria-hidden="true"></i></button> ');
						}
						$copy.find('.evCtrls').append('<button data-evid="'+eventData[i].id+'" class="btn  btnDel btn-danger"><i class="fa fbtn fa-trash-o" title="Delete" aria-hidden="true"></i></button> ');
						
						$copy.find('div.byChef').html( T );
						$copy.clone().appendTo('#tab_my');
						$('#tab_my p.help-block').remove();
						$('#tab_my button.btnQR').remove();
						inTab += '_My_';
						continue; // dont show on any other tab "User should not be able to join their own event" Alex 6Dec2016
					}
					if(!empty(eventData[i].Attending)){		// I m attecnding it
						$copy.clone().appendTo('#tab_attending').find('.btnUsers').remove();
						$('#tab_attending p.help-block').remove();	
						//inTab++;
						inTab += '_Attending_';
					}
					
					if(  inTab.indexOf('Attending') == -1 ){ // not in attending
						
						//if( mo.isAfter(moment()) || mo.isSame(moment(),'day')  ){ // Today or In future. 
								var APD = $copy.clone().appendTo('#tab_nearby');
								$('#tab_nearby p.help-block').remove();
								$('#tab_nearby button.btnUsers').remove();
						//}
					}
					
					
				}
				//$DTemp.remove();
			}else{
				//$('#chef-foods').html('<center>No Events Found!</center>');
			}
		}else { 
			BAlert.find('.modal-header h3').html('<i class="fa fa-exclamation-triangle"></i> '+cLan.Error);
			BAlert.find('.modal-body').html('<p class="text-danger">'+data.Msg+'</p>');
			BAlert.modal();
		}
		if (data.JS) { eval(data.JS); }
	
	}); // ajax	
}



function loadDishes(thisEvent){
	var H = '<div class="eventSec"><strong>Chef(s) that are serving:</strong><br>';
	var I = '<div class="eventSec"><strong>Dish(es) to be served:</strong><br>';
	var chefs = JSON.parse(thisEvent.chef_data);
	for(var i=0; i<chefs.length; i++){
		var ch = chefs[i];
		H += '<div class="indent"><i class="icon-chef colorGrey"></i> '+ch.company+'</div>';
		//H += '<i class="icon-chef colorGrey"></i> '+ch.company+'<ul class="list-group">';
		
		for(var j=0; j< ch.dishes.length; j++){
			I += '<div class="indent"><i class="fa fa-bullseye colorGrey"></i> &nbsp;'+ch.dishes[j].name +'</div>';
		}
		
	}
	
	return H+'</div>'+I+'</div>';
}

</script>
</body>
</html>